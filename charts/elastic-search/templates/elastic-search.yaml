{{- $elasticInstances := .Values.elasticInstances | default 1 | int }}
{{- range $i := until $elasticInstances }}
---
apiVersion: elasticsearch.k8s.elastic.co/v1
kind: Elasticsearch
metadata:
  name: elasticsearch-{{ $i }}
  namespace: {{ $.Release.Namespace }}
spec:
  version: {{ $.Values.elasticVersion }}
  secureSettings:
    - secretName: keystore
  http:
    tls:
      selfSignedCertificate:
        disabled: true
    service:
      spec:
        type: ClusterIP
  nodeSets:
    - name: default
      count: 1
      podTemplate:
        metadata:
          labels:
            azure.workload.identity/use: "true"
        spec:
          serviceAccountName: workload-identity-sa
          containers:
            - name: elasticsearch
              env:
                - name: AZURE_FEDERATED_TOKEN_FILE
                  value: /usr/share/elasticsearch/config/azure/tokens/azure-identity-token
              volumeMounts:
                - name: azure-identity-token
                  mountPath: /usr/share/elasticsearch/config/azure/tokens
      # volumeClaimTemplates:
      #   - metadata:
      #       name: elasticsearch-data
      #     spec:
      #       accessModes:
      #         - ReadWriteOnce
      #       resources:
      #         requests:
      #           storage: {{ $.Values.storageSize }}
      #       storageClassName: {{ $.Values.storageClass | default "managed-premium" }}
      # config:
      #   node.roles: [ "master", "data", "ingest" ]
      #   node.store.allow_mmap: false
      #   # Snapshot
      #   plugin.mandatory: repository-azure
      #   azure.client.default.auth: workload_identity
      
{{- end }}
